<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: tasks/html/validate.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: tasks/html/validate.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * @module tasks/html/validate
 */

/**
 * taskFactory
 * @param basePath
 * @param teams
 * @returns task {Function}
 */
module.exports = function(basePath, teams) {

    return function task(done) {

        var gutil = require('gulp-util');
        var childProcess = require('child_process');
        var phantomPath = require('phantomjs').path;
        var w3cjs = require('w3cjs');
        var path = require('path');
        var dir = require('node-dir');
        var pages = [];

        var counter = 0,
            totalErrors = 0;


        function formatMessage(obj, done) {
            for (var x = 0; x &lt; obj.length; x++) {
                if (obj[x].type === 'error') {
                    gutil.log(gutil.colors.red('Error at line: ') + gutil.colors.blue(obj[x].lastLine) + ' ' + obj[x].message);
                    totalErrors++;
                }
            }

            counter++;
            if (counter === pages.length) {
                if (totalErrors > 0) {
                    gutil.log(gutil.colors.red('\nTotal W3C Errors: ') + totalErrors + gutil.colors.red(' in ') + pages.length + gutil.colors.red(' pages'));
                    done();
                } else {
                    done();
                }
            }
        }

        function openPage(childArgs, done) {

            var pageName = childArgs[1];

            gutil.log(gutil.colors.green('Analysing Page: ') + pageName);

            childProcess.execFile(phantomPath, childArgs, {
                timeout: 60000
            }, function(err, stdout, stderr) {

                if (stderr) {
                    gutil.log(gutil.colors.red('Error getting headless data for \'%s\' (stderr): %s: ' + stderr));
                }

                if (err) {
                    gutil.log(gutil.colors.red('Error analysing page: ') + pageName);
                    gutil.log(gutil.colors.red(err));
                }

                w3cjs.validate({
                    input: stdout, // file can either be a local file or a remote file
                    output: 'json', // Defaults to 'json', other option includes html
                    doctype: 'HTML5',
                    charset: 'utf-8',
                    callback: function(res) {
                        gutil.log(gutil.colors.cyan('\n--------- W3C analysis for ' + gutil.colors.green(pageName) + ' ---------'));
                        formatMessage(res.messages, done);
                    }
                });
            });
        }

        function openPages(pages) {

            for (var x = 0; x &lt; pages.length; x++) {
                var childArgs = [
                    path.join(__dirname, 'phantomjs-script.js'),
                    pages[x]
                ];

                openPage(childArgs, done, x);
            }
        }

        function getAllPages(basePath, teams) {

            if (global.argv.page !== undefined) {
                openPages(pages.push(global.argv.page));
            } else {
                var counter = 0;

                for (var team in teams) {
                    if (teams.hasOwnProperty(team)) {
                        var dirPath = path.resolve(basePath + '../../../' + teams[team].views + '/default/pages'); //directory path
                        dir.readFiles(dirPath, {
                            match: /index.html/,
                            exclude: /^\./
                        }, function(err, content, next) {
                            if (err) {
                                throw err;
                            }
                            next();
                        },
                        function(err, files) {
                            if (err) {
                                throw err;
                            }
                            for (var i = 0; i &lt; files.length; i++) {
                                pages.push(files[i].split('views/default/pages')[1].split('/index.html')[0]);
                            }
                            counter++;

                            if (counter === Object.keys(teams).length) {
                                openPages(pages);
                            }
                        });
                    }
                }
            }
        }

        getAllPages(basePath, teams);
    };
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-fear-core-tasks.html">fear-core-tasks</a></li><li><a href="module-tasks_copy-inline-mocks.html">tasks/copy-inline-mocks</a></li><li><a href="module-tasks_css.html">tasks/css</a></li><li><a href="module-tasks_css_inline.html">tasks/css/inline</a></li><li><a href="module-tasks_css_minify.html">tasks/css/minify</a></li><li><a href="module-tasks_eslint_details.html">tasks/eslint/details</a></li><li><a href="module-tasks_eslint_message-filter.html">tasks/eslint/message-filter</a></li><li><a href="module-tasks_eslint_on-change.html">tasks/eslint/on-change</a></li><li><a href="module-tasks_eslint_report.html">tasks/eslint/report</a></li><li><a href="module-tasks_eslint_result-filter.html">tasks/eslint/result-filter</a></li><li><a href="module-tasks_fs.html">tasks/fs</a></li><li><a href="module-tasks_fs_copy.html">tasks/fs/copy</a></li><li><a href="module-tasks_fs_delete.html">tasks/fs/delete</a></li><li><a href="module-tasks_html.html">tasks/html</a></li><li><a href="module-tasks_html_minify.html">tasks/html/minify</a></li><li><a href="module-tasks_html_remove.html">tasks/html/remove</a></li><li><a href="module-tasks_html_validate.html">tasks/html/validate</a></li><li><a href="module-tasks_install-dependencies.html">tasks/install-dependencies</a></li><li><a href="module-tasks_javascript.html">tasks/javascript</a></li><li><a href="module-tasks_javascript_annotate.html">tasks/javascript/annotate</a></li><li><a href="module-tasks_javascript_bundle.html">tasks/javascript/bundle</a></li><li><a href="module-tasks_javascript_minify.html">tasks/javascript/minify</a></li><li><a href="module-tasks_javascript_timestamp.html">tasks/javascript/timestamp</a></li><li><a href="module-tasks_mocks_copy-mocks.html">tasks/mocks/copy-mocks</a></li><li><a href="module-tasks_sass.html">tasks/sass</a></li><li><a href="module-tasks_sass_compile.html">tasks/sass/compile</a></li><li><a href="module-tasks_sass_generate-docs.html">tasks/sass/generate-docs</a></li><li><a href="module-tasks_sass_lint-on-change.html">tasks/sass/lint-on-change</a></li><li><a href="module-tasks_start-karma-runner.html">tasks/start-karma-runner</a></li><li><a href="module-tasks_start-karma-server.html">tasks/start-karma-server</a></li><li><a href="module-tasks_watch.html">tasks/watch</a></li><li><a href="module-tasks_watch-and-lint-on-change.html">tasks/watch-and-lint-on-change</a></li></ul><h3>Classes</h3><ul><li><a href="jsPackageHelper.html">jsPackageHelper</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Dec 18 2015 10:36:46 GMT+0000 (GMT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
